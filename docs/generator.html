<!DOCTYPE html>
<html>

<head>
    <title>Exzellenz Generator</title>

    <link rel="icon" href=favicon.ico>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Merriweather|Muli|Roboto&display=swap" rel="stylesheet">

    <link href="default.css" rel="stylesheet">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8">
</head>

<body>
    <div class="navbar-fixed">
        <nav>
            <div class="blue darken-3 nav-wrapper">
                <div class="container">
                    <a href="#" data-target="sidebar-mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                    <a href="generator.html" class="brand-logo">EXZELLENZ</a>
                    <ul id="nav-mobile" class="right hide-on-med-and-down">
                        <li class="active"><a class="header-nav-link" href="generator.html">Generator</a></li>
                        <li><a class="header-nav-link" href="https://github.com/just-max/exzellenz">GitHub</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </div>

    <ul class="sidenav" id="sidebar-mobile">
        <li class="active"><a class="header-nav-link" href="generator.html">Generator</a></li>
        <li><a class="header-nav-link" href="https://github.com/just-max/exzellenz">GitHub</a></li>
    </ul>

    <div class="container">
        <div class="section">
            <h2 class="header">Text Generator</h2>
        </div>
        <div class="row">
		    <div class="input-field col xl5 m4 s8">
				<input id="output-text" type="text" required pattern="[A-Za-z ]+" class="validate">
				<label for="output-text">Text</label>
		    </div>
		    <div class="input-field col xl1 m2 s4">
				<select id="output-format">
				  <option value="output-format-svg" selected>SVG</option>
				  <option value="output-format-png" disabled>PNG (coming soon)</option>
				</select>
				<label>Format</label>
		    </div>
		    <div class="col m6 s12">
		    	<div id="output-container" class="container">
		    	</div>
		    </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  	<script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            M.Sidenav.init(document.querySelectorAll('.sidenav'));
            M.FormSelect.init(document.querySelectorAll('select'));
            
            var textInputBox = document.getElementById('output-text');
            var outputTypeSelect = document.getElementById('output-format');
            
            var canvas = SVG().addTo("#output-container").size('100%', '100%');
            
            // uncomment this line to visualize the canvas
            //canvas.rect('100%', '100%').fill("#0000007f");
            
            var DEFAULT_SIZE = 100;
            var M_MULT = 811/1024;
            
            var outputTextElement = canvas.plain("");
            outputTextElement.fill("#1565c0");
            outputTextElement.font({
  				family:   'exzellenz',
  				size:     DEFAULT_SIZE
			});
            
            var defaultTransform = outputTextElement.transform();
            console.log(defaultTransform);
            
            function validateInputs() {
            	return textInputBox.checkValidity() && outputTypeSelect.checkValidity();
            }
            
            // allows getting the size of the actual canvas, NOT the size occupied by drawn elements
            function getCanvasBBox() {
            	// draw an invisible rectangle over the whole canvas
            	var r = canvas.rect('100%', '100%').fill("#00000000");
            	// get its bounding box
            	var b = r.bbox();
            	// remove the invisible rectangle
            	r.remove();
            	
            	// return the relevant numbers
            	//return { 'width': b.width, 'height', b.height };
            	return b;
            }
            
            var drawText = function() {
            	outputTextElement.transform(defaultTransform);
            	
            	var outputText = validateInputs() ? textInputBox.value : 'ERROR';
            	outputTextElement.text(outputText);
            	
            	var canvasBBox = getCanvasBBox();
            	var textBBox = outputTextElement.bbox();
            	
            	var sf = canvasBBox.width / textBBox.width;
            	
            	outputTextElement.scale(sf, 0, 0);
            	outputTextElement.move(0, 0);
            	
            	canvas.height(Math.ceil(M_MULT * sf * outputTextElement.bbox().height));
            }
            
            drawText();
            textInputBox.addEventListener('input', drawText);
            window.addEventListener('resize', drawText);
        });
    </script>
</body>

</html>
